## Tensorflow Benchmark On GPU

#### 环境
* 系统
    * Ubuntu Server 16.04
* 硬件
    * 腾讯云计算型【GN8】的一颗核心
        * vcpu: 6核
        * 内存：56G
        * 处理器型号：Intel Xeon E5-2680 v4(2.4 GHz)
        * 内网带宽：1.5 Gbps
        * vgpu：1颗 Tesla P40
* 测试软件
    * [Tensorflow benchmarks](https://github.com/tensorflow/benchmarks)
* 测试软件依赖
    * [Nvidia Driver Version: 396.37](https://www.nvidia.cn/download/driverResults.aspx/135974/cn)
    * [CUDA Toolkit 9.0](https://developer.nvidia.com/cuda-downloads)
        * 目前CUDA最新版本是9.2 但与 1.9版的TF不兼容，而9.0版本可以
    * [cuDNN](https://developer.nvidia.com/rdp/cudnn-download)
    * Tensorflow 1.9.0
    * python2.7 / 3.5

#### 过程
* 安装Nvidia驱动
* 安装CUDA Toolkit
* 下载cuDNN
    * 把cuDNN的头文件和库文件放到cuda的安装目录（/usr/lcoal/cuda/）对应的位置
* 安装tensorflow
    * py2.7
        * `pip install tensorflow-gpu==1.9`
    * py3.5
        * `pip install tensorflow-gpu==1.9`
* 下载Tensorflow benchmarks
    * git clone
* 运行 tf_cnn_benchmarks.py(位于 benchmarks/scripts/tf_cnn_benchmarks )
    * py2.7
        * `python tf_cnn_benchmarks.py`
    * py3.5
        * `python3 tf_cnn_benchmarks.py`
* 更换数据集
    * 以上的运行是使用默认的数据集，可以通过添加运行参数更改数据集
    * 使用 `python tf_cnn_benchmarks.py --helpfull` 查看所有参数
    * 更换为CIFAR数据集的参数的例子
        * `python tf_cnn_benchmarks.py --data_dir=/home/ubuntu/CIFAR/cifar-10-batches-py/ --data_name=cifar10`

#### 可能遇到的错误

* python里import tensorflow时
    ```
    # 错误
    ImportError: libcublas.so.9.0: cannot open shared object file: No such file or directory

    # 解决方案：把 /usr/local/cuda/lib64 放入动态链接库的路径
    # 在 /etc/ld.so.conf.d 中新建文件 cuda.conf
    # 在 cuda.conf 中写入cuda的动态库路径
        库路径: /usr/local/cuda/lib64
    ```

#### 运行结果

Step    Img/sec total_loss
1       images/sec: 9873.3 +/- 0.0 (jitter = 0.0)       2.510
10      images/sec: 8598.0 +/- 456.1 (jitter = 1403.2)  2.570
20      images/sec: 8743.3 +/- 308.9 (jitter = 1099.6)  2.471
30      images/sec: 8579.5 +/- 252.4 (jitter = 1183.3)  2.489
40      images/sec: 8482.1 +/- 215.6 (jitter = 1137.4)  2.515
50      images/sec: 8436.6 +/- 181.5 (jitter = 1067.2)  2.538
60      images/sec: 8388.4 +/- 156.2 (jitter = 1024.0)  2.467
70      images/sec: 8449.9 +/- 137.4 (jitter = 895.6)   2.544
80      images/sec: 8514.6 +/- 125.8 (jitter = 927.0)   2.485
90      images/sec: 8536.7 +/- 117.4 (jitter = 952.7)   2.503
100     images/sec: 8554.9 +/- 107.5 (jitter = 887.5)   2.480
----------------------------------------------------------------
total images/sec: 8402.52
----------------------------------------------------------------
