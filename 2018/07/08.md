## 虚拟化概述

#### 处理器虚拟化
* 指令模拟
    * VMM运行在最高特权，可以控制Host OS处理器的所有关键资源，而Guest OS运行在非最高全特权，所以敏感指令会陷入到VMM中通过软件的方式进行模拟
* 中断与异常的模拟
* SMP（对称多处理的结构）

#### 内存虚拟化
* 主要解决两个问题
    1. 维护 Guest 物理地址到 Host 物理地址之间的映射
        * Guest OS 维护进程的虚拟地址(GVA)到OS的物理地址(GPA)映射
            * GPA = f(GVA)
        * VMM 维护 Guest 物理地址(GPA)到 Host 物理地址(HPA)映射
            * HPA = g(GPA) = g(f(GVA))
    2. 截获虚拟机对 Guest 物理地址的访问，并根据映射转换为 Host 的物理地址

#### I/O虚拟化
* 设备发现
* 访问截获
* 设备模拟
* 设备共享

#### VMM的功能和组成
* 虚拟环境管理
    * 虚拟资源
        1. 处理器虚拟化模块
        2. 内存虚拟化模块
        3. 设备虚拟化模块
    * 虚拟环境的调度
    * 虚拟机间的通信机制
    * 虚拟化环境的管理接口
* 物理资源管理
    * 处理器管理
    * 内存管理
    * 中断管理
    * 系统时间维护
    * 设备管理

#### VMM分类
* 按虚拟的平台分类
    * 完全虚拟化（无需对操作系统进行任何更改）
        * 软件辅助的完全虚拟化
        * 硬件辅助的完全虚拟化  
    * 类虚拟化（可能对操作系统进行修改使之适应环境）

* 按VMM的实现结构分类
    * Hypervisor模型
        * VMM可以被看做一个完整的OS，只不过是为了虚拟化设计的
        * 所有的物理资源（CPU、内存、I/O）都归VMM管理
        * 优点
            * VMM同时具备物理资源的管理能力和虚拟化功能，因此物理资源虚拟化的效率会更高
        * 缺点
            * 设备驱动的开发工作量大
    * 宿主模型
        * VMM通过宿主操作系统的服务获得资源，实现处理器、内存、I/O设备的虚拟化
        * VMM建出虚拟机后，通常将虚拟机作为宿主操作系统的一个进程参与调度
        * 优缺点与Hypervisor相反
        * 优点
            * 可以充分利用宿主操作系统的设备驱动程序，不需VMM实现
        * 缺点
            * 效率较低
    * 混合模型
        * VMM依旧在最底层，拥有所有的物理资源，但与Hypervisor的区别是VMM会让出大部分I/O的控制权交由特权虚拟机中的特权操作系统来控制
        * 结合了上面两个的优点
        * 缺点是当需要运行在特权虚拟机中的特权操作系统提供服务时，VMM需要切换到特权操作系统，若频繁切换，会产生较多的山下文开销，降低性能


#### Reference
* <<系统虚拟化——原理与实现>>