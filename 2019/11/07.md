## Hugepage

#### HugePage的好处
1. 减少TLB miss
2. 减少页表所占内存空间
3. 普通HugePage不可swap，减少内存swap

* 其中最大的好处就是减少TLB miss
* TLB中存储了线性地址的页号对应的PTE（理解为key value对）
![地址转换](https://pic1.zhimg.com/80/v2-dc1762ce1eb07aeeb827792b3b34701c_hd.jpg)
* 在给定线性地址时，去查找TLB，如果在TLB中找到了对应线性地址的页号，就可以获取对应的PTE，省略了中间页表寻址的过程，就会减少每次页表寻址时的物理内存访问。
    * 以4级页表为例，需要访问物理内存，正常通过页表需要访问内存5次（4次用来查页表，1次访问内存数据），而通过TLB只需要1次（直接访问内存数据）


* TLB miss：在使用HugePage时
    * 如果是2M的hugepage，此时page从4K（offset 0~11）变成2M（offset 0~20）。那么一个TLB的PTE从4K变成2M，访问这2M内的所有物理地址，只需要一个TLB的entry，而4K的PTE需要 2^21/2^12 = 512个entry，也就是说TLB可以缓存的物理地址范围最多可扩大512倍，也就最多可减少512倍的TLB miss，也就最多可减少512 * 4 = 2048次的物理内存访问。
    * 如果是1G的hugepage，最多可减少 2^30/2^12 = 2^18次的物理内存访问。

#### Hugepage配置
* hugepage是常驻内存的，开机就分配。配置在内核的启动参数中，

##### Reference
* [Intel x86 CPU的地址转换加速机制](https://zhuanlan.zhihu.com/p/50201492)