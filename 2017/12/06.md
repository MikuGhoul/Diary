## Principles of Operating Systems
* part 6

### 处理机调度

#### 处理机调度概念
* 进程切换
    * CPU资源的当前占用者切换
        * 保存当前进程在PCB中的执行上下文
        * 恢复下一个进程的执行上下文
* 处理机调度
    * 从就绪队列中挑选下一个占用CPU运行的进程
    * 从多个可用的CPU中挑选就绪进程可使用的CPU
* 调度时机
    * 内核运行调度程序的条件
        * 进程从运行状态切换到等待状态
        * 进程被终结
    * 非抢占系统
        * 当前进程主动放弃CPU时
    * 抢占系统
        * 中断请求被服务例程响应完成时
            * 进程时间片用完
            * 进程从等待切换到就绪

#### 调度策略
* 处理机资源的使用模式
    * 进程在CPU计算和I/O操作间交替
        * 每次调度决定在下一个CPU计算时将哪个工作交给CPU
        * 在时间片机制下，进程可能在结束当前CPU计算前被迫放弃CPU
* 调度算法比较准则
    * CPU使用率
        * CPU处于忙状态的**时间百分比**
    * 吞吐量
        * 单位时间内完成的**进程数量**
    * 周转时间
        * 进程从初始化到结束（包括等待）的总时间
    * 等待时间
        * 进程在就绪队列中的总时间
    * 响应时间
        * 从提交请求到产生响应所花费的总时间

#### 调度算法
* 先来先服务算法（FCFS）
    * 依据进程进入就绪状态的**先后顺序**排列
        * 进程进入**等待**或**结束**状态时，就绪队列中的下一个进程占用CPU
    * 优点
        * 简单
    * 缺点
        * 平均等待时间波动较大
            * **短进程可能排在长进程后面**
        * I/O资源和CPU资源的利用率较低
            * CPU密集型进程会导致I/O设备空闲时，I/O密集型进程也等待
* 短进程优先算法（SPN）
    * 选择就绪队列中**执行时间最短**进程占用CPU进入运行状态
    * 短剩余时间优先算法（SRT）
        * SPN的可抢占改进版
    * SPN算法具有**最优**平均周转时间
    * 特征
        * 可能导致饥饿
            * 不断产生短进程，导致长进程无法获得CPU资源
    * 需要进行执行时间预估
        * 用历史的执行时间来预估未来的执行时间
        * `下一次执行时间的预测 = 衰减系数 * 本次执行时间 + 上一次的预估值`
            * 每次执行时间做衰减，最近的一次影响权重最大
* 最高响应比优先算法（HRRN）
    * 选择就绪队列中响应比`R值`最高的进程
        * `R = (w + s) / s`
            * w: 等待时间
            * s: 预估执行时间
        * SPN的改进，解决饥饿问题
        * 不可抢占
* 时间片轮转算法（RR）
    * 时间片
        * 分配处理机资源的基本时间单元
    * 思路
        * 时间片结束时，按FCFS算法切换到下一个就绪队列进程
        * 每隔（n - 1）个时间片进程执行一个时间片
            * **每个进程分到了1/n的时间**
    * 时间片长度
        * RR算法开销
            * 额外的上下文切换
        * 时间片太大
            * 等待时间过长
            * 退化成FCFS
        * 时间片太小
            * 反应迅速，但产生大量上下文切换
            * 大量上下文切换开销影响到系统吞吐量
        * 经验
            * 维持上下文切换开销在1%以内
* 多级反馈队列算法（MLFQ）
    * 多级队列（MQ）
        * 就绪队列被划分成多个独立的子队列
        * **每个队列拥有自己的调度策略**
        * 队列间的调度
            * 固定优先级
                * 可能导致饥饿
            * 时间片轮转
    * MLFQ是进程可以在不同队列间移动的MQ
        * **时间片大小随优先级别增加而增加**
            * 优先越级高，时间片越小
        * **如果进程在当前的时间片没有完成，则降到下一个优先级**
    * 特征
        * CPU密集型进程的优先级下降很快，时间片会被分的大
        * I/O密集型进程停留在高优先级，时间片会被分的很小
* 公平共享调度算法（FSS）
    * 控制用户对系统资源的访问
        * 一些用户组比其他用户组更重要
        * 保证不重要的用户无法垄断资源
        * **未使用的资源按比例分**
        * **没有达到资源使用率目标的组获得更高的优先级**

* 比较
    * FCFS
        * 不公平，平均等待时间较差
    * SPN
        * 不公平，平均周转时间最小
        * 需要精确预测计算时间
        * 可能导致饥饿
    * HRRN
        * 基于SPN调度
        * 不可抢占
    * RR
        * 公平，但平均等待时间较差
    * MLFQ
        * 多种算法的集成
    * FSS
        * 公平是第一衡量指标

#### 实时调度 & 多处理机调度
* 实时操作系统
    * 正确性依赖于其**时间**和**功能**两方面的操作系统
* 周期实时任务
* 软时限和硬时限
* 可调度性
    * 表示一个实时操作系统能够满足任务时限要求
        * 需要确定实时任务的执行顺序
        * 静态优先级调度
            * 速率单调调度算法
                * 通过周期安排优先级
                * 周期越短优先级越高
                * 执行周期短的任务
        * 动态优先级调度
            * 最早截止时间优先算法
                * 截止时间越早优先级越高
                * 执行截止时间最早的任务
* 多处理器调度
    * 每个处理器运行自己的调度程序
    * 调度程序对共享资源的访问需要进行同步
    * 静态进程分配
        * 进程从开始到结束都被分配到一个**固定的处理机**上运行
        * 每个处理机有自己的就绪队列
        * 调度开销小
        * 各处理机可能**闲忙不均**
    * 动态进程分配
        * 进程在**执行中**可分配到**任意**空闲处理机执行
        * 所有处理机**共享**一个公共的就绪队列
        * 调度开销大
        * 各处理机的**负载是均衡的**

#### 优先级反置
* 高优先级进程长时间等待低优先级进程所占用资源的现象
* 基于优先级的**可抢占**调度算法
* 优先级进程
    * 占用资源的低优先级进程**继承**申请资源的高优先级进程的**优先级**
        * **高优先级进程**请求**低优先级进程**此时占用的资源
        * 只有在占有资源的**低优先级进程**被堵塞时，才提高占有资源进程的优先级
* 优先级天花板协议
    * 占有资源的进程的优先级和所有**可能申请**该资源的进程的**最高优先级**相同
        * 不管是否发生等待，优先级都会提高